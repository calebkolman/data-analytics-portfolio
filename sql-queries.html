<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SQL Queries</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header>
    <h1>SQL Code Samples</h1>
    <nav>
      <a href="index.html">Home</a>
    </nav>
  </header>
  <main>
    <section id="sql-examples">
      <h2>Table of Contents</h2>
      <ul>
        <li><a href="#joins">Joins</a></li>
        <li><a href="#aggregates">Aggregates</a></li>
        <li><a href="#cte">Common Table Expressions (CTEs)</a></li>
        <li><a href="#partitions">Partitions</a></li>
        <li><a href="#data-cleaning">Data Cleaning Techniques</a></li>
      </ul>

      <!-- Example 1: Joins -->
      <div id="joins" class="project">
        <h3>Joins</h3>
        <p>This query retrieves counts of content scanned, flagged, and deleted for each active business user.</p>
        <pre><code>
SELECT
    bc."userId" AS business_customer_id,
    b."name" AS business_name,
    COUNT(DISTINCT c."id") AS num_scanned_content,
    COUNT(DISTINCT CASE WHEN c."isFlagged" = true THEN c."id" END) AS num_flagged_content,
    COUNT(DISTINCT CASE WHEN c."isDeleted" = true THEN c."id" END) AS num_deleted_content
FROM
    public."BusinessCustomer" AS bc
LEFT JOIN
    public."Business" AS b ON bc."businessId" = b."id"
LEFT JOIN
    public."Content" AS c ON bc."userId" = c."userId"
WHERE
    b."businessStatus" = 'Active'
GROUP BY
    bc."userId", b."name"
ORDER BY
    business_customer_id;
        </code></pre>
      </div>

      <!-- Example 2: Aggregates -->
      <div id="aggregates" class="project">
        <h3>Aggregates</h3>
        <p>This query calculates the number of distinct users connected to each social media platform.</p>
        <pre><code>
SELECT 
    SUM(CASE WHEN "origin" = 'Facebook' THEN 1 ELSE 0 END) AS "FacebookUsers",
    SUM(CASE WHEN "origin" = 'Twitter' THEN 1 ELSE 0 END) AS "TwitterUsers",
    SUM(CASE WHEN "origin" = 'Instagram' THEN 1 ELSE 0 END) AS "InstagramUsers",
    SUM(CASE WHEN "origin" = 'Tiktok' THEN 1 ELSE 0 END) AS "TiktokUsers"
FROM 
    (SELECT DISTINCT "userId", "origin" FROM "Content") AS distinct_origins;
        </code></pre>
      </div>

      <!-- Example 3: Common Table Expressions (CTEs) -->
      <div id="cte" class="project">
        <h3>Common Table Expressions (CTEs)</h3>
        <p>This query uses a CTE to clean duplicate rows in the dataset.</p>
        <pre><code>
WITH cte AS (
    SELECT 
        "id",
        ROW_NUMBER() OVER (
            PARTITION BY "contentId", "userId", "type"
            ORDER BY "createdAt"
        ) AS row_num
    FROM public."ContentAnalysis"
)
DELETE FROM public."ContentAnalysis"
WHERE "id" IN (
    SELECT "id" 
    FROM cte 
    WHERE row_num > 1
);
        </code></pre>
      </div>

      <!-- Example 4: Partitions -->
      <div id="partitions" class="project">
        <h3>Partitions</h3>
        <p>This query demonstrates how to use partitions for row-level operations, such as keeping only the earliest created record.</p>
        <pre><code>
WITH cte AS (
    SELECT 
        "id",
        ROW_NUMBER() OVER (
            PARTITION BY "contentId", "userId", "type"
            ORDER BY "createdAt"
        ) AS row_num
    FROM public."ContentAnalysis"
)
DELETE FROM public."ContentAnalysis"
WHERE "id" IN (
    SELECT "id" 
    FROM cte 
    WHERE row_num > 1
);
        </code></pre>
      </div>

      <!-- Example 5: Data Cleaning Techniques -->
      <div id="data-cleaning" class="project">
        <h3>Data Cleaning Techniques</h3>
        <p>This series of SQL commands demonstrates how to clean and standardize data.</p>

        <!-- Step 1 -->
        <h4>Step 1: Remove Rows with Missing Critical Columns</h4>
        <pre><code>
DELETE FROM public."ContentAnalysis"
WHERE "contentId" IS NULL
   OR "userId" IS NULL
   OR "type" IS NULL;
        </code></pre>

        <!-- Step 2 -->
        <h4>Step 2: Handle Duplicate Rows</h4>
        <pre><code>
WITH cte AS (
    SELECT 
        "id",
        ROW_NUMBER() OVER (
            PARTITION BY "contentId", "userId", "type"
            ORDER BY "createdAt"
        ) AS row_num
    FROM public."ContentAnalysis"
)
DELETE FROM public."ContentAnalysis"
WHERE "id" IN (
    SELECT "id" 
    FROM cte 
    WHERE row_num > 1
);
        </code></pre>

        <!-- Step 3 -->
        <h4>Step 3: Handle Inconsistent Data in the "type" Column</h4>
        <pre><code>
UPDATE public."ContentAnalysis"
SET "type" = UPPER("type")
WHERE "type" IS NOT NULL;
        </code></pre>

        <!-- Step 4 -->
        <h4>Step 4: Fill Missing Values with Defaults</h4>
        <pre><code>
UPDATE public."ContentAnalysis"
SET "type" = 'UNKNOWN'
WHERE "type" IS NULL;
        </code></pre>

        <!-- Step 5 -->
        <h4>Step 5: Verify Data Consistency</h4>
        <pre><code>
SELECT * 
FROM public."ContentAnalysis"
WHERE "updatedAt" < "createdAt";
        </code></pre>
      </div>
    </section>
  </main>
  <footer>
    <p>&copy; 2024 Caleb Kolman. All rights reserved.</p>
  </footer>
</body>
</html>
